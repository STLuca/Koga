parser machineReference;

structures {
    core.Reference;
}

core.InterfaceReference<Document R> {

    Byte[4] objectAddr;
    Byte[4] objectTable;
    Byte[4] interfaceTable;

    constructor(Reference r) {
        i(ADD, TI, LDA, objectAddr, ADA, r.objectAddr, IL, 0d0);
        i(ADD, TI, LDA, objectTable, ADA, r.objectTable, IL, 0d0);
        Byte[2] interfaceClassSymbol;
        Symbol(INTERFACE, interfaceClassSymbol, AG, r.R, LG, R);
        c(ADDR, LI, interfaceTable, table, interfaceClassSymbol);
    }

    invoke(Name methodName) {
        Byte[4] iMethodSymbol;
        Byte[4] frameSize;
        Byte[4] methodAddr;
        Byte[4] newTask;
        Byte[4] statusOut;

        ~ Create the new task
        i(ADD, LI, LDA, newTask, R, task, LDA, newTask);
        i(ADD, LI, LDA, status, R, task, LDA, status);
        Symbol(METHOD, methodSymbol, LG, R, AL, methodName);
        c(ADDR, LI, iMethodSymbol, table, methodSymbol);
        c(SIZE, TT, LDA, frameSize, LDA, interfaceTable, LDA, iMethodSymbol);
        c(ADDR, TT, LDA, methodAddr, LDA, interfaceTable, LDA, iMethodSymbol);
        Admin(TASK, newTask, objectAddr, objectTable, methodAddr, frameSize, statusOut);


        Byte[4] frameDataAddr;
        i(ADD, TI, LDA, frameDataAddr, LDA, newTask, IL, 0d0);
        Args();
        Admin(AWAIT_TASK, newTask);
    }

    arg(Variable a, Name methodName) {
        ArgsCopy(LG, R, AL, methodName, AL, index, ADA, a, LDA, frameDataAddr);
        ~ m(COPY, TII, LDA, frameDataAddr, ADA, a, ADS, a);
        ~ i(ADD, TI, LDA, frameDataAddr, LDA, frameDataAddr, ADS, a);
    }

}