parser machine;

usables {
    core.Int;
    core.ArrayPointer;
}

core.Connection {

    Byte[4] pageOne;
    Byte[4] pageTwo;
    Byte[4] instance; ~ breaks if before pageOne, not sure why yet

    constructor fromArray(Int instance, ArrayPointer ptr) {
        i(ADD, TI, LDA, instance, ADA, instance.val, IL, 0d0);
        m(COPY, ITI, LDA, pageOne, ADA, ptr.start, IL, 0d8);
    }

    constructor(Int pageOne, Int pageTwo, Int instance) {
        i(ADD, TI, LDA, pageOne, ADA, pageOne, IL, 0d0);
        i(ADD, TI, LDA, pageTwo, ADA, pageTwo, IL, 0d0);
        i(ADD, TI, LDA, instance, ADA, instance, IL, 0d0);
    }

    constructor connect(Int instance, Name protocol, Name method) {
        Byte[4] protocolMethodAddr;
        Symbol(METHOD, protocolMethodSymbol, AL, protocol, AL, method);
        c(ADDR, LI, protocolMethodAddr, table, protocolMethodSymbol);

        Byte[4] adminConnectMethod;
        Symbol(METHOD, adminConnectSymbol, IL, core.Administrator, IL, connect);
        c(ADDR, LI, adminConnectMethod, table, adminConnectSymbol);

        Byte[4] this;
        i(ADD, LI, LDA, this, R, task, LDA, pageOne);

        ~ copy the instance, protocolMethodAddr, and Pointer to this args
        Byte[4] adminTask;
        i(ADD, LI, LDA, adminTask, R, altTask, IL, 0d0);

        m(COPY, TII, LDA, adminTask, ADA, instance, ADA, instance);
        i(ADD, TI, LDA, adminTask, LDA, adminTask, ADS, instance);
        m(COPY, TII, LDA, adminTask, LDA, protocolMethodAddr, LDS, protocolMethodAddr);
        i(ADD, TI, LDA, adminTask, LDA, adminTask, LDS, protocolMethodAddr);
        m(COPY, TII, LDA, adminTask, LDA, this, LDS, this);

        logician(START_ADMIN, T, LDA, adminConnectMethod);
    }

}