parser machineComposite;

structures {
    core.Int;
    core.ArrayAccessor;
}

core.Connection {

    Byte[4] pageOne;
    Byte[4] pageTwo;
    Byte[4] instance; ~ breaks if before pageOne, not sure why yet

    constructor fromArray(Int instance, ArrayAccessor<Int> ptr) {
        i(ADD, TI, P, instance, P, instance.val, I, 0d0);
        m(COPY, ITI, P, pageOne, P, ptr.start, I, 0d8);
    }

    constructor(Int pageOneIn, Int pageTwoIn, Int instanceIn) {
        i(ADD, TI, P, pageOne, P, pageOneIn.val, I, 0d0);
        i(ADD, TI, P, pageTwo, P, pageTwoIn.val, I, 0d0);
        i(ADD, TI, P, instance, P, instanceIn.val, I, 0d0);
    }

    constructor connect(Int instanceIn, Name protocol, Name operation) {
        Byte[4] protocolMethodAddr;
        Symbol(METHOD, protocolMethodSymbol, L, protocol, L, operation);
        c(ADDR, LI, protocolMethodAddr, table, protocolMethodSymbol);

        Byte[4] adminConnectMethod;
        Symbol(METHOD, adminConnectSymbol, I, core.Administrator, I, connect);
        c(ADDR, LI, adminConnectMethod, table, adminConnectSymbol);

        Byte[4] this;
        i(ADD, LI, P, this, R, task, P, pageOne);

        ~ copy the instance, protocolMethodAddr, and Pointer to this args
        Byte[4] adminTask;
        i(ADD, LI, P, adminTask, R, altTask, I, 0d0);

        m(COPY, TII, P, adminTask, P, instanceIn.val, P, instanceIn.val);
        i(ADD, TI, P, adminTask, P, adminTask, S, instanceIn);
        m(COPY, TII, P, adminTask, P, protocolMethodAddr, S, protocolMethodAddr);
        i(ADD, TI, P, adminTask, P, adminTask, S, protocolMethodAddr);
        m(COPY, TII, P, adminTask, P, this, S, this);

        logician(START_ADMIN, T, P, adminConnectMethod);
    }

}