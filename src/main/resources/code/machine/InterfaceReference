parser machineReference;

structures {
    core.Reference;
}

core.InterfaceReference<Document R> {

    Byte[4] objectAddr;
    Byte[4] objectTable;
    Byte[4] interfaceTable;

    constructor(Reference r) {
        i(ADD, TI, P, objectAddr, P, r.objectAddr, I, 0d0);
        i(ADD, TI, P, objectTable, P, r.objectTable, I, 0d0);
        Byte[2] interfaceClassSymbol;
        Symbol(INTERFACE, interfaceClassSymbol, G, r.R, G, R);
        c(ADDR, LI, interfaceTable, table, interfaceClassSymbol);
    }

    invoke(Name methodName) {
        Byte[4] iMethodSymbol;
        Byte[4] frameSize;
        Byte[4] methodAddr;
        Byte[4] newTask;
        Byte[4] statusOut;

        ~ Create the new task
        i(ADD, LI, P, newTask, R, task, P, newTask);
        i(ADD, LI, P, status, R, task, P, status);
        Symbol(METHOD, methodSymbol, G, R, L, methodName);
        c(ADDR, LI, iMethodSymbol, table, methodSymbol);
        c(SIZE, TT, P, frameSize, P, interfaceTable, P, iMethodSymbol);
        c(ADDR, TT, P, methodAddr, P, interfaceTable, P, iMethodSymbol);
        Admin(TASK, newTask, objectAddr, objectTable, methodAddr, frameSize, statusOut);


        Byte[4] frameDataAddr;
        i(ADD, TI, P, frameDataAddr, P, newTask, I, 0d0);
        Args();
        Admin(AWAIT_TASK, newTask);
    }

    arg(Variable a, Name methodName) {
        ArgsCopy(G, R, L, methodName, L, index, P, a, P, frameDataAddr);
        ~ m(COPY, TII, P, frameDataAddr, P, a, S, a);
        ~ i(ADD, TI, P, frameDataAddr, P, frameDataAddr, S, a);
    }

}