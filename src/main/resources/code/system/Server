parser host;

usables {
    core.InputStream;
    core.OutputStream;
    core.AdminRef;
    core.Int;
    core.Boolean;
    core.While;
    core.If;
    core.Array;
    core.ArrayPointer;
    core.Pointer;
    core.Thread;
    core.String;
    core.Reference;
    core.Task;
    core.Connection;
    core.Exit;
}

documents {
    util.SimpleAdministrator;
    chatting.Chat;
    chatting.Chatting;
}

test.Server supports Chatting {

    main() {
        AdminRef admin init();

        Connection conn;
        Pointer<Connection> connPtr (conn);
        admin listen(connPtr);

        Reference<Server> t this();
        t chat(conn);

        Exit;
    }

    chat(Connection conn) {
        Reference<Chat> chat new();
        chat asServer(conn);
        String str;
        Pointer<String> strPtr (str);

        chat read(strPtr);
        String expected "hello server";
        Boolean isGreeting { str == expected; };
        If (isGreeting) {
            String response "hello client";
            chat write(response);
        } else {
            String response "huh";
            chat write(response);
        };

        Task t complete();
    }

}